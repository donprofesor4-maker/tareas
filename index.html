const CONFIG = {
  FOLDER_NAME: 'Entregas Tecnología - ' + new Date().getFullYear(),
  SHEET_NAME: 'Registro Tecnología',
  MAX_FILE_SIZE_MB: 10
};

function doPost(e) {
  try {
    // Log inicial
    console.log('=== NUEVA PETICIÓN ===');
    console.log('Tipo:', e ? typeof e : 'undefined');
    
    if (!e || !e.postData) {
      console.log('Error: No hay postData');
      return jsonResponse({
        success: false,
        error: 'No se recibieron datos'
      });
    }

    console.log('Tamaño datos:', e.postData.contents.length);
    
    // Parsear datos
    let data;
    try {
      data = JSON.parse(e.postData.contents);
    } catch (parseError) {
      console.log('Error parse:', parseError);
      return jsonResponse({
        success: false,
        error: 'Error al parsear datos: ' + parseError.message
      });
    }

    console.log('Datos recibidos:', {
      nombre: data.studentName,
      id: data.studentId,
      grado: data.grade,
      archivos: data.files ? data.files.length : 0
    });

    // Validaciones
    if (!data.studentName || !data.studentId || !data.grade) {
      return jsonResponse({
        success: false,
        error: 'Faltan datos requeridos'
      });
    }

    if (!data.files || data.files.length === 0) {
      return jsonResponse({
        success: false,
        error: 'No se recibieron archivos'
      });
    }

    // Crear estructura de carpetas: Tecnología / Grado / Alumno_ID
    const rootFolder = getOrCreateFolder(CONFIG.FOLDER_NAME);
    const gradeFolder = getOrCreateSubFolder(rootFolder, data.grade);
    const studentFolderName = sanitizeFileName(data.studentName + '_' + data.studentId);
    const studentFolder = getOrCreateSubFolder(gradeFolder, studentFolderName);

    console.log('Carpeta destino:', studentFolder.getName());

    // Guardar archivos
    const savedFiles = [];
    const errors = [];

    for (let i = 0; i < data.files.length; i++) {
      const fileData = data.files[i];
      
      try {
        if (!fileData.data) {
          throw new Error('Sin datos base64');
        }

        console.log('Guardando:', fileData.name);
        
        const decoded = Utilities.base64Decode(fileData.data);
        const blob = Utilities.newBlob(
          decoded, 
          fileData.type || 'application/octet-stream', 
          fileData.name
        );
        const savedFile = studentFolder.createFile(blob);
        
        savedFiles.push({
          name: fileData.name,
          url: savedFile.getUrl(),
          id: savedFile.getId()
        });
        
        console.log('✓ Guardado:', fileData.name);
        
      } catch (fileError) {
        console.error('✗ Error:', fileData.name, fileError);
        errors.push(fileData.name + ': ' + fileError.message);
      }
    }

    // Registrar en spreadsheet
    logSubmission(data, savedFiles);

    console.log('=== ÉXITO ===');
    
    return jsonResponse({
      success: savedFiles.length > 0,
      message: `Guardados ${savedFiles.length} archivo(s)`,
      files: savedFiles,
      folderUrl: studentFolder.getUrl()
    });

  } catch (error) {
    console.error('Error general:', error);
    return jsonResponse({
      success: false,
      error: error.message
    });
  }
}

function doGet(e) {
  return jsonResponse({
    status: 'online',
    message: 'Servicio Tecnología activo',
    timestamp: new Date().toISOString()
  });
}

function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateFolder(name) {
  const folders = DriveApp.getFoldersByName(name);
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder(name);
}

function getOrCreateSubFolder(parent, name) {
  const folders = parent.getFoldersByName(name);
  if (folders.hasNext()) return folders.next();
  return parent.createFolder(name);
}

function sanitizeFileName(name) {
  return name.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50);
}

function logSubmission(data, files) {
  let ss = SpreadsheetApp.getActiveSpreadsheet();
  
  if (!ss) {
    ss = SpreadsheetApp.create(CONFIG.SHEET_NAME);
    const sheet = ss.getActiveSheet();
    sheet.appendRow(['Fecha', 'Nombre', 'Matrícula', 'Grado', 'Materia', 'Archivos', 'Links']);
  }
  
  const sheet = ss.getActiveSheet();
  
  sheet.appendRow([
    new Date(),
    data.studentName,
    data.studentId,
    data.grade,
    'Tecnología',
    files.map(f => f.name).join(', '),
    files.map(f => f.url).join('\n')
  ]);
}

// Función de prueba
function testSetup() {
  console.log('Probando...');
  const folder = getOrCreateFolder(CONFIG.FOLDER_NAME);
  console.log('✓ Carpeta:', folder.getName());
  
  // Probar crear subcarpeta
  const testGrade = getOrCreateSubFolder(folder, 'Primaria 1°');
  console.log('✓ Subcarpeta:', testGrade.getName());
  
  console.log('✓ Todo listo');
}
